"""
Generate statistics and visualizations for the progress report.
"""

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
import os

# Set style
sns.set_style("whitegrid")
plt.rcParams['figure.figsize'] = (10, 6)
plt.rcParams['font.size'] = 10

def generate_dataset_statistics():
    """Generate dataset statistics."""
    stats = {
        'total_contracts': 2000,
        'training_set': 1600,
        'test_set': 400,
        'vulnerable_train': 320,
        'safe_train': 1280,
        'vulnerable_test': 80,
        'safe_test': 320,
        'vulnerable_percentage': 20.0,
        'safe_percentage': 80.0
    }
    return stats

def generate_model_comparison_chart():
    """Generate model comparison visualization."""
    # Find the latest results file
    import glob
    result_files = glob.glob('results/results_*.csv')
    if not result_files:
        print("No results file found!")
        return
    latest_file = max(result_files)
    print(f"Using results file: {latest_file}")
    results = pd.read_csv(latest_file, index_col=0)  # Use first column as index
    
    fig, axes = plt.subplots(2, 2, figsize=(12, 10))
    
    # F1-Score comparison
    ax1 = axes[0, 0]
    models = results.index.values  # Use index as model names
    f1_scores = results['f1_score'].values
    colors = ['#1f77b4', '#ff7f0e', '#2ca02c']
    ax1.bar(range(len(models)), f1_scores, color=colors[:len(models)])
    ax1.set_xticks(range(len(models)))
    ax1.set_xticklabels([m.replace('_', ' ').title() for m in models], rotation=15, ha='right')
    ax1.set_ylabel('F1-Score')
    ax1.set_title('Model F1-Score Comparison')
    ax1.set_ylim([0, 0.35])
    ax1.grid(axis='y', alpha=0.3)
    
    # Precision vs Recall
    ax2 = axes[0, 1]
    precision = results['precision'].values
    recall = results['recall'].values
    ax2.scatter(precision, recall, s=200, alpha=0.6, c=colors[:len(models)])
    for i, model in enumerate(models):
        ax2.annotate(model.replace('_', ' ').title(), (precision[i], recall[i]), 
                    xytext=(5, 5), textcoords='offset points')
    ax2.set_xlabel('Precision')
    ax2.set_ylabel('Recall')
    ax2.set_title('Precision vs Recall')
    ax2.set_xlim([0, 0.25])
    ax2.set_ylim([0, 0.5])
    ax2.grid(alpha=0.3)
    
    # False Positive Rate
    ax3 = axes[1, 0]
    fpr = results['false_positive_rate'].values
    ax3.bar(range(len(models)), fpr, color=colors[:len(models)])
    ax3.set_xticks(range(len(models)))
    ax3.set_xticklabels([m.replace('_', ' ').title() for m in models], rotation=15, ha='right')
    ax3.set_ylabel('False Positive Rate')
    ax3.set_title('False Positive Rate Comparison')
    ax3.set_ylim([0, 0.5])
    ax3.grid(axis='y', alpha=0.3)
    
    # Accuracy
    ax4 = axes[1, 1]
    accuracy = results['accuracy'].values
    ax4.bar(range(len(models)), accuracy, color=colors[:len(models)])
    ax4.set_xticks(range(len(models)))
    ax4.set_xticklabels([m.replace('_', ' ').title() for m in models], rotation=15, ha='right')
    ax4.set_ylabel('Accuracy')
    ax4.set_title('Model Accuracy Comparison')
    ax4.set_ylim([0, 0.8])
    ax4.grid(axis='y', alpha=0.3)
    
    plt.tight_layout()
    plt.savefig('results/model_comparison.png', dpi=300, bbox_inches='tight')
    print("Saved model comparison chart to results/model_comparison.png")
    
def generate_dataset_distribution_chart():
    """Generate dataset distribution visualization."""
    fig, axes = plt.subplots(1, 2, figsize=(12, 5))
    
    # Training set distribution
    ax1 = axes[0]
    train_labels = ['Vulnerable', 'Safe']
    train_counts = [320, 1280]
    colors = ['#d62728', '#2ca02c']
    ax1.pie(train_counts, labels=train_labels, autopct='%1.1f%%', 
            colors=colors, startangle=90)
    ax1.set_title('Training Set Distribution (n=1,600)')
    
    # Test set distribution
    ax2 = axes[1]
    test_labels = ['Vulnerable', 'Safe']
    test_counts = [80, 320]
    ax2.pie(test_counts, labels=test_labels, autopct='%1.1f%%', 
            colors=colors, startangle=90)
    ax2.set_title('Test Set Distribution (n=400)')
    
    plt.tight_layout()
    plt.savefig('results/dataset_distribution.png', dpi=300, bbox_inches='tight')
    print("Saved dataset distribution chart to results/dataset_distribution.png")

if __name__ == "__main__":
    os.makedirs('results', exist_ok=True)
    generate_model_comparison_chart()
    generate_dataset_distribution_chart()
    print("\nStatistics generation complete!")

