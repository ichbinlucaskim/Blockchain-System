"""
Quick test script to verify the pipeline works with sample data.
Run this to test the code before using the actual dataset.
"""

import sys
import os

# Add src directory to path
sys.path.append(os.path.join(os.path.dirname(__file__), 'src'))

from data_loader import ContractDataLoader
from feature_extractor import FeatureExtractor
from models import ModelTrainer
import numpy as np

def test_pipeline():
    """Test the complete pipeline with sample data."""
    print("="*60)
    print("Testing Smart Contract Vulnerability Detection Pipeline")
    print("="*60)
    
    # Step 1: Load sample data
    print("\n[Step 1] Loading sample data...")
    data_loader = ContractDataLoader(data_dir="data")
    contracts, labels = data_loader.load_dataset(max_contracts=100)
    
    print(f"Loaded {len(contracts)} contracts")
    print(f"Vulnerable: {sum(labels)}, Safe: {len(labels)-sum(labels)}")
    
    # Step 2: Split data
    print("\n[Step 2] Splitting data...")
    X_train_raw, X_test_raw, y_train, y_test = data_loader.get_data_split(
        contracts, labels, test_size=0.2, random_state=42
    )
    
    # Step 3: Extract features
    print("\n[Step 3] Extracting features...")
    feature_extractor = FeatureExtractor()
    X_train = feature_extractor.extract_features(X_train_raw)
    X_test = feature_extractor.extract_features(X_test_raw)
    
    print(f"Feature matrix shape: {X_train.shape}")
    print(f"Number of features: {X_train.shape[1]}")
    
    # Step 4: Train a simple model (just Logistic Regression for quick test)
    print("\n[Step 4] Training Logistic Regression model (quick test)...")
    trainer = ModelTrainer(models_dir="models")
    
    # Use simpler hyperparameters for quick test
    from sklearn.linear_model import LogisticRegression
    from sklearn.model_selection import cross_val_score
    
    model = LogisticRegression(random_state=42, class_weight='balanced', max_iter=1000)
    cv_scores = cross_val_score(model, X_train, y_train, cv=3, scoring='f1')
    print(f"CV F1-scores: {cv_scores}")
    print(f"Mean CV F1-score: {cv_scores.mean():.4f}")
    
    model.fit(X_train, y_train)
    
    # Step 5: Evaluate
    print("\n[Step 5] Evaluating on test set...")
    metrics = trainer.evaluate_model(model, X_test, y_test, "Logistic Regression")
    
    print("\n" + "="*60)
    print("TEST COMPLETED SUCCESSFULLY!")
    print("="*60)
    print(f"Test F1-score: {metrics['f1_score']:.4f}")
    print(f"Test Precision: {metrics['precision']:.4f}")
    print(f"Test Recall: {metrics['recall']:.4f}")
    print("="*60)
    
    return True

if __name__ == "__main__":
    try:
        test_pipeline()
    except Exception as e:
        print(f"\nERROR: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)

