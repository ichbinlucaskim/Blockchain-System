"""
Quick validation test for new features.
Tests Slither integration, SmartBugs loader, and feature extraction.
"""

import sys
import os
sys.path.append(os.path.join(os.path.dirname(__file__), 'src'))

print("="*60)
print("Quick Feature Validation Test")
print("="*60)

# Test 1: Feature Extractor with Slither
print("\n[Test 1] Testing FeatureExtractor with Slither integration...")
try:
    from feature_extractor import FeatureExtractor
    extractor = FeatureExtractor()
    print(f"✓ FeatureExtractor initialized")
    print(f"  - Slither available: {extractor.slither_extractor is not None}")
    
    # Test feature extraction on sample contract
    sample_contract = """
    pragma solidity ^0.8.0;
    
    contract TestContract {
        uint256 public value;
        
        function setValue(uint256 _value) public {
            value = _value;
        }
    }
    """
    
    features = extractor._extract_single_contract_features(sample_contract)
    feature_names = extractor.get_feature_names()
    
    print(f"✓ Feature extraction successful")
    print(f"  - Total features: {len(features)}")
    print(f"  - Feature names: {len(feature_names)}")
    print(f"  - Expected: 110 features (71 basic + 39 Slither)")
    
    if len(features) >= 71:
        print(f"✓ Feature count is correct (at least basic features)")
    else:
        print(f"⚠ Feature count is lower than expected")
        
except Exception as e:
    print(f"✗ FeatureExtractor test failed: {e}")
    import traceback
    traceback.print_exc()

# Test 2: SmartBugs Loader
print("\n[Test 2] Testing SmartBugs Loader...")
try:
    from smartbugs_loader import SmartBugsLoader
    loader = SmartBugsLoader(None)
    print(f"✓ SmartBugsLoader initialized")
    print(f"  - Can load labels from JSON/CSV")
    print(f"  - Can match contracts to labels")
except Exception as e:
    print(f"✗ SmartBugsLoader test failed: {e}")

# Test 3: Data Loader with SmartBugs support
print("\n[Test 3] Testing DataLoader with SmartBugs support...")
try:
    from data_loader import ContractDataLoader
    loader = ContractDataLoader(data_dir="data", smartbugs_dir=None)
    print(f"✓ ContractDataLoader initialized with SmartBugs support")
    print(f"  - SmartBugs loader: {loader.smartbugs_loader is not None}")
except Exception as e:
    print(f"✗ DataLoader test failed: {e}")

# Test 4: Slither Extractor
print("\n[Test 4] Testing SlitherFeatureExtractor...")
try:
    from slither_extractor import SlitherFeatureExtractor
    slither_extractor = SlitherFeatureExtractor()
    print(f"✓ SlitherFeatureExtractor initialized")
    print(f"  - Available: {slither_extractor.available}")
    print(f"  - Feature count: {slither_extractor.get_feature_count()}")
    print(f"  - Expected: 39 features")
    
    if slither_extractor.get_feature_count() == 39:
        print(f"✓ Feature count is correct")
    else:
        print(f"⚠ Feature count mismatch")
        
except Exception as e:
    print(f"✗ SlitherFeatureExtractor test failed: {e}")

# Test 5: Model Trainer
print("\n[Test 5] Testing ModelTrainer...")
try:
    from models import ModelTrainer
    trainer = ModelTrainer(models_dir="models")
    print(f"✓ ModelTrainer initialized")
    print(f"  - Can train Logistic Regression")
    print(f"  - Can train Random Forest")
    print(f"  - Can train XGBoost (if available)")
except Exception as e:
    print(f"✗ ModelTrainer test failed: {e}")

print("\n" + "="*60)
print("Quick Validation Test Complete!")
print("="*60)
print("\nNext steps:")
print("1. Run full test: python test_pipeline.py")
print("2. Run main pipeline: python main.py --max-contracts 2000")
print("3. Run hyperparameter tuning: python tune_hyperparameters.py")

